name: Push to Kaggle

on:
  push:
    branches:
      - master
    paths:
      - 'kaggle_iacgpt_training.ipynb'
      - 'claude.yml'
      - '.github/workflows/push-to-kaggle.yml'
  workflow_dispatch:

jobs:
  push-notebook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install UV
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      - name: Setup Python
        run: uv python install 3.10

      - name: Install dependencies
        run: uv sync

      - name: Setup Kaggle credentials
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Push notebook to Kaggle
        run: |
          uv run python scripts/kaggle_runner.py --timeout-hours 4
          echo "âœ… Notebook pushed to Kaggle!"
          echo "ðŸ”— View at: https://www.kaggle.com/code/nicksmoore/iacgpt-v2"
          echo "âš ï¸  Click 'Run' on Kaggle to start training"

      - name: Summary
        run: |
          echo "## ðŸ“¤ Notebook Pushed to Kaggle" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Your IaC-GPT notebook has been uploaded to Kaggle." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Notebook pushed via API" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸  Manual 'Run' required (Kaggle API limitation)" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ Max Runtime: 4 hours" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Visit [your kernel on Kaggle](https://www.kaggle.com/code/nicksmoore/iacgpt-v2)" >> $GITHUB_STEP_SUMMARY
          echo "2. Click the **Run** button (top right)" >> $GITHUB_STEP_SUMMARY
          echo "3. Training will start on GPU P100" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Monitor:** \`kaggle kernels output nicksmoore/iacgpt-v2\`" >> $GITHUB_STEP_SUMMARY
